module vm;

import base;

struct VMState {
  int result-id, ray-id;
  
  Ray* ray-stack;
  alias ray = &ray-stack[ray-id - 1];
  alias rays = ray-stack[0 .. ray-id];
  
  Result* result-stack;
  alias result = &result-stack[result-id - 1];
  alias results = result-stack[0 .. result-id];
  
  CommandHandler[] stream;
  
  int x, y;
  
  alias handler = stream[0];
  alias allocResult = `
    result-id ++;
  `;
  alias freeResult = `
    result-id -= !!;
  `;
  alias allocRay = `
    ray-id ++;
  `;
  alias freeRay = `
    ray-id -= !!;
  `;
}
